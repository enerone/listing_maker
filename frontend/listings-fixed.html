<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listings Creados - Amazon Listing Generator - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Inline critical CSS to avoid 404 */
        .listings-table {
            table-layout: fixed;
            width: 100%;
            min-width: 800px;
        }
        .listings-table th:nth-child(1) { width: 25%; }
        .listings-table th:nth-child(2) { width: 12%; }
        .listings-table th:nth-child(3) { width: 8%; }
        .listings-table th:nth-child(4) { width: 15%; }
        .listings-table th:nth-child(5) { width: 10%; }
        .listings-table th:nth-child(6) { width: 18%; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <i class="fas fa-list-alt text-3xl text-blue-600 mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Listings Creados - Fixed</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="create-listing.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Crear Nuevo Listing
                    </a>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-400 mr-2" id="statusIndicator"></div>
                        <span class="text-sm text-gray-600" id="systemStatus">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Listings</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalListings">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Publicados</p>
                        <p class="text-2xl font-semibold text-gray-900" id="publishedListings">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Borradores</p>
                        <p class="text-2xl font-semibold text-gray-900" id="draftListings">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status and Controls -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium">Estado del Sistema</h3>
                <button onclick="loadListings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Recargar
                </button>
            </div>
        </div>

        <!-- Listings Display -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Lista de Listings</h3>
            </div>
            
            <div id="loadingState" class="p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Cargando listings...</p>
            </div>
            
            <div id="emptyState" class="p-8 text-center hidden">
                <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay listings</h3>
                <p class="text-gray-600 mb-4">Aún no has creado ningún listing.</p>
            </div>
            
            <div id="listingsTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="listings-table min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-full hidden">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Configuration
        // Usar configuración dinámica de API base URL
        const API_BASE_URL = window.Config ? window.Config.getApiBaseUrl() : 
            `${window.location.protocol}//${window.location.hostname}:${window.location.port || '8000'}`;
        
        // Global variables
        let allListings = [];
        let filteredListings = [];
        
        console.log('🚀 Fixed listings.js loaded!');
        
        // Utility function to safely get element
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }
        
        // Toast function
        function showToast(message, type = 'info') {
            console.log('showToast called:', { message, type });
            try {
                const toast = safeGetElement('toast');
                const toastMessage = safeGetElement('toastMessage');
                
                if (!toast || !toastMessage) {
                    console.warn('Toast elements not found, using console fallback');
                    console.log(`TOAST (${type}): ${message}`);
                    return;
                }
                
                toastMessage.textContent = message;
                
                let bgColor;
                switch(type) {
                    case 'success': bgColor = 'bg-green-500 text-white'; break;
                    case 'error': bgColor = 'bg-red-500 text-white'; break;
                    case 'warning': bgColor = 'bg-yellow-500 text-white'; break;
                    default: bgColor = 'bg-blue-500 text-white'; break;
                }
                
                toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${bgColor}`;
                toast.classList.remove('hidden', 'translate-y-full');
                
                setTimeout(() => {
                    toast.classList.add('translate-y-full');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000);
                
                console.log('✅ Toast shown successfully');
            } catch (error) {
                console.error('❌ Error showing toast:', error);
                console.log(`FALLBACK TOAST (${type}): ${message}`);
            }
        }
        
        // Update statistics
        function updateStats() {
            console.log('updateStats called');
            try {
                const totalListings = allListings.length;
                const publishedListings = allListings.filter(listing => listing.status === 'published').length;
                const draftListings = allListings.filter(listing => listing.status === 'draft').length;
                
                console.log('📊 Calculated stats:', { totalListings, publishedListings, draftListings });
                
                const totalEl = safeGetElement('totalListings');
                const publishedEl = safeGetElement('publishedListings');
                const draftEl = safeGetElement('draftListings');
                
                if (totalEl) {
                    totalEl.textContent = totalListings.toString();
                    console.log('✅ Set totalListings to:', totalListings);
                }
                
                if (publishedEl) {
                    publishedEl.textContent = publishedListings.toString();
                    console.log('✅ Set publishedListings to:', publishedListings);
                }
                
                if (draftEl) {
                    draftEl.textContent = draftListings.toString();
                    console.log('✅ Set draftListings to:', draftListings);
                }
                
                console.log('✅ Stats updated successfully');
            } catch (error) {
                console.error('❌ Error updating stats:', error);
                showToast('Error updating statistics', 'error');
            }
        }
        
        // Load listings from API
        async function loadListings() {
            console.log('🚀 loadListings started');
            
            // Show loading state
            const loadingEl = safeGetElement('loadingState');
            const emptyEl = safeGetElement('emptyState');
            const tableEl = safeGetElement('listingsTable');
            
            if (loadingEl) loadingEl.classList.remove('hidden');
            if (emptyEl) emptyEl.classList.add('hidden');
            if (tableEl) tableEl.classList.add('hidden');
            
            try {
                console.log('📡 Fetching from API...');
                const response = await fetch(`${API_BASE_URL}/listings/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('📦 Response received:', { status: response.status, ok: response.ok });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Data parsed:', { total: data.total, count: data.listings?.length });
                
                // Process listings
                allListings = (data.listings || []).map(listing => ({
                    ...listing,
                    category: listing.category ? listing.category.replace('ProductCategory.', '') : 'Sin categoría',
                    confidence_score: Number(listing.confidence_score || 0),
                    price: listing.target_price || listing.price || 0
                }));
                
                filteredListings = [...allListings];
                
                console.log('🔄 Processing complete, updating display...');
                
                // Update stats
                updateStats();
                
                // Render table
                renderTable();
                
                console.log('🎉 Listings loaded successfully!');
                showToast(`${allListings.length} listings cargados correctamente`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading listings:', error);
                showToast('Error al cargar listings: ' + error.message, 'error');
                
                // Show empty state
                if (loadingEl) loadingEl.classList.add('hidden');
                if (emptyEl) emptyEl.classList.remove('hidden');
                if (tableEl) tableEl.classList.add('hidden');
            }
        }
        
        // Render table
        function renderTable() {
            console.log('renderTable called');
            
            const loadingEl = safeGetElement('loadingState');
            const emptyEl = safeGetElement('emptyState');
            const tableEl = safeGetElement('listingsTable');
            const tbody = safeGetElement('listingsTableBody');
            
            if (allListings.length === 0) {
                if (loadingEl) loadingEl.classList.add('hidden');
                if (emptyEl) emptyEl.classList.remove('hidden');
                if (tableEl) tableEl.classList.add('hidden');
                return;
            }
            
            // Show table
            if (loadingEl) loadingEl.classList.add('hidden');
            if (emptyEl) emptyEl.classList.add('hidden');
            if (tableEl) tableEl.classList.remove('hidden');
            
            if (tbody) {
                tbody.innerHTML = allListings.map(listing => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-4 border-b">
                            <div class="font-medium text-gray-900">${listing.product_name || 'N/A'}</div>
                            <div class="text-sm text-gray-500 truncate">${listing.title || 'Sin título'}</div>
                        </td>
                        <td class="px-2 py-4 border-b text-sm">${listing.category || 'N/A'}</td>
                        <td class="px-2 py-4 border-b text-sm font-medium">$${(listing.price || 0).toFixed(2)}</td>
                        <td class="px-2 py-4 border-b">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                listing.status === 'published' 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${listing.status || 'draft'}
                            </span>
                        </td>
                        <td class="px-2 py-4 border-b text-sm">${formatDate(listing.created_at)}</td>
                        <td class="px-2 py-4 border-b">
                            <div class="flex space-x-2">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
                                    Ver
                                </button>
                                <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">
                                    Duplicar
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                console.log('✅ Table rendered with', allListings.length, 'rows');
            }
        }
        
        // Format date helper
        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return 'N/A';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM ready, initializing...');
            
            // Verify critical elements exist
            const requiredElements = ['totalListings', 'publishedListings', 'draftListings', 'toast', 'toastMessage'];
            const missing = requiredElements.filter(id => !document.getElementById(id));
            
            if (missing.length > 0) {
                console.error('❌ Missing required elements:', missing);
                alert('Page initialization error: Missing elements ' + missing.join(', '));
                return;
            }
            
            console.log('✅ All required elements found');
            
            // Load listings
            setTimeout(() => {
                console.log('🚀 Starting auto-load...');
                loadListings();
            }, 100);
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('❌ Global error:', event.error);
            showToast('Se produjo un error inesperado', 'error');
        });
        
        console.log('📝 Script loaded completely');
    </script>
</body>
</html>
