<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Enhanced Listings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Inline the critical table styles */
        .listings-table {
            table-layout: fixed;
            width: 100%;
            min-width: 800px;
        }
        .listings-table th:nth-child(1) { width: 25%; }
        .listings-table th:nth-child(2) { width: 12%; }
        .listings-table th:nth-child(3) { width: 8%; }
        .listings-table th:nth-child(4) { width: 15%; }
        .listings-table th:nth-child(5) { width: 10%; }
        .listings-table th:nth-child(6) { width: 18%; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">üêõ Debug Enhanced Listings</h1>
        
        <!-- Debug Console -->
        <div class="bg-gray-900 text-green-400 p-4 rounded-lg mb-6 font-mono text-sm">
            <div id="debugConsole">Debug console initialized...</div>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Listings</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalListings">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Publicados</p>
                        <p class="text-2xl font-semibold text-gray-900" id="publishedListings">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Borradores</p>
                        <p class="text-2xl font-semibold text-gray-900" id="draftListings">-</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status indicators -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <div id="loadingState" class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Cargando listings...</p>
            </div>
            
            <div id="emptyState" class="text-center hidden">
                <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay listings</h3>
                <p class="text-gray-600">No se encontraron listings</p>
            </div>
            
            <div id="listingsTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="listings-table min-w-full divide-y divide-gray-200 border-collapse">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">Producto</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">Categor√≠a</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">Precio</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">Estado</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border">Fecha</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border bg-yellow-100">üéØ ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Manual Test Buttons -->
        <div class="bg-white p-6 rounded-lg shadow space-y-4">
            <h3 class="font-bold text-lg">Manual Tests</h3>
            <div class="space-x-4">
                <button onclick="testLoadListings()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Test Load Listings</button>
                <button onclick="testShowStats()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Test Show Stats</button>
                <button onclick="testShowToast()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">Test Toast</button>
                <button onclick="testShowTable()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">Test Show Table</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-full hidden">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Debug console function
        function debugLog(message) {
            const console = document.getElementById('debugConsole');
            if (console) {
                console.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
                console.scrollTop = console.scrollHeight;
            }
        }
        
        // Override console.log to also show in debug console
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            debugLog('LOG: ' + args.join(' '));
        };
        
        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            debugLog('ERROR: ' + args.join(' '));
        };
        
        // Global variables for testing
        let allListings = [];
        let filteredListings = [];
        
        // Show toast function
        function showToast(message, type = 'info') {
            try {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                if (!toast || !toastMessage) {
                    console.warn('Toast elements not found');
                    return;
                }
                
                toastMessage.textContent = message;
                
                let bgColor;
                switch(type) {
                    case 'success': bgColor = 'bg-green-500 text-white'; break;
                    case 'error': bgColor = 'bg-red-500 text-white'; break;
                    case 'warning': bgColor = 'bg-yellow-500 text-white'; break;
                    default: bgColor = 'bg-blue-500 text-white'; break;
                }
                
                toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${bgColor}`;
                toast.classList.remove('hidden', 'translate-y-full');
                
                setTimeout(() => {
                    toast.classList.add('translate-y-full');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000);
                
                console.log('Toast shown:', { message, type });
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }
        
        // Update stats function
        function updateStats() {
            try {
                const totalListings = allListings.length;
                const publishedListings = allListings.filter(listing => listing.status === 'published').length;
                const draftListings = allListings.filter(listing => listing.status === 'draft').length;
                
                const totalEl = document.getElementById('totalListings');
                const publishedEl = document.getElementById('publishedListings');
                const draftEl = document.getElementById('draftListings');
                
                if (totalEl) {
                    totalEl.textContent = totalListings;
                } else {
                    console.warn('Element totalListings not found');
                }
                
                if (publishedEl) {
                    publishedEl.textContent = publishedListings;
                } else {
                    console.warn('Element publishedListings not found');
                }
                
                if (draftEl) {
                    draftEl.textContent = draftListings;
                } else {
                    console.warn('Element draftListings not found');
                }
                
                console.log('Stats updated:', { totalListings, publishedListings, draftListings });
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Load listings function
        async function loadListings() {
            try {
                console.log('Starting to load listings...');
                
                const response = await fetch('http://localhost:8000/listings/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', { total: data.total, count: data.listings?.length });
                
                allListings = (data.listings || []).map(listing => ({
                    ...listing,
                    category: listing.category ? listing.category.replace('ProductCategory.', '') : 'Sin categor√≠a',
                    confidence_score: Number(listing.confidence_score || 0),
                    price: listing.target_price || listing.price || 0
                }));
                
                filteredListings = [...allListings];
                
                updateStats();
                renderTable();
                
                console.log('Listings loaded successfully!');
                showToast('Listings cargados correctamente', 'success');
                
            } catch (error) {
                console.error('Error loading listings:', error);
                showToast('Error al cargar listings: ' + error.message, 'error');
            }
        }
        
        // Render table function
        function renderTable() {
            const loadingEl = document.getElementById('loadingState');
            const emptyEl = document.getElementById('emptyState');
            const tableEl = document.getElementById('listingsTable');
            const tbody = document.getElementById('listingsTableBody');
            
            if (allListings.length === 0) {
                if (loadingEl) loadingEl.classList.add('hidden');
                if (emptyEl) emptyEl.classList.remove('hidden');
                if (tableEl) tableEl.classList.add('hidden');
                return;
            }
            
            if (loadingEl) loadingEl.classList.add('hidden');
            if (emptyEl) emptyEl.classList.add('hidden');
            if (tableEl) tableEl.classList.remove('hidden');
            
            if (tbody) {
                tbody.innerHTML = allListings.map(listing => `
                    <tr>
                        <td class="px-3 py-4 whitespace-nowrap border">
                            <div class="font-medium text-gray-900">${listing.product_name || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${listing.title || 'N/A'}</div>
                        </td>
                        <td class="px-2 py-4 whitespace-nowrap border text-sm">${listing.category || 'N/A'}</td>
                        <td class="px-2 py-4 whitespace-nowrap border text-sm">$${listing.price || 0}</td>
                        <td class="px-2 py-4 whitespace-nowrap border">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${listing.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${listing.status || 'draft'}
                            </span>
                        </td>
                        <td class="px-2 py-4 whitespace-nowrap border text-sm">${new Date(listing.created_at).toLocaleDateString()}</td>
                        <td class="px-2 py-4 whitespace-nowrap border text-sm">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">Ver</button>
                            <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs ml-1">Duplicar</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        // Test functions
        function testLoadListings() {
            console.log('Testing load listings...');
            loadListings();
        }
        
        function testShowStats() {
            console.log('Testing show stats...');
            allListings = [
                { status: 'published' },
                { status: 'draft' },
                { status: 'draft' }
            ];
            updateStats();
        }
        
        function testShowToast() {
            console.log('Testing toast...');
            showToast('This is a test toast message!', 'success');
        }
        
        function testShowTable() {
            console.log('Testing show table...');
            allListings = [
                {
                    id: 1,
                    product_name: 'Test Product',
                    title: 'Test Title',
                    category: 'ELECTRONICS',
                    price: 99.99,
                    status: 'draft',
                    created_at: new Date().toISOString()
                }
            ];
            renderTable();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            debugLog('Page initialized, ready for testing');
            
            // Auto-load listings on page load
            setTimeout(() => {
                console.log('Auto-loading listings...');
                loadListings();
            }, 1000);
        });
    </script>
</body>
</html>
