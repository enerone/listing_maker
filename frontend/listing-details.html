<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Listing - Amazon Listing Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .agent-result { border-left: 4px solid #e5e7eb; }
        .agent-result.success { border-left-color: #10b981; }
        .agent-result.partial { border-left-color: #f59e0b; }
        .agent-result.error { border-left-color: #ef4444; }
        
        /* Estilos para recomendaciones aplicadas */
        .recommendation-applied {
            transition: all 0.3s ease;
            animation: appliedPulse 0.5s ease-in-out;
        }
        
        .recommendation-applied-item {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .recommendation-applied-item::after {
            content: '‚úì Aplicada';
            position: absolute;
            top: 8px;
            right: 8px;
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Animaci√≥n para bot√≥n aplicado */
        @keyframes appliedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Estilos para galer√≠a de im√°genes */
        .image-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .image-overlay {
            transition: opacity 0.2s ease;
        }
        
        .image-card:hover .image-overlay {
            opacity: 1;
        }
        
        .aspect-square {
            aspect-ratio: 1 / 1;
        }
        
        .grid-responsive {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <a href="/listings.html" class="text-blue-600 hover:text-blue-800 mr-4">
                        <i class="fas fa-arrow-left mr-2"></i>Volver a Listings
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Detalles del Listing</h1>
                        <p class="text-sm text-gray-600">Vista completa del listing generado</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="exportListing()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                    <button onclick="editListing()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-edit mr-2"></i>Editar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Listing Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center mb-4">
                        <span id="listingId" class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm font-medium mr-4">ID: #</span>
                        <span id="listingStatus" class="px-3 py-1 rounded-full text-sm font-medium">Status</span>
                        <span id="listingConfidence" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium ml-4">Confianza: 0%</span>
                    </div>
                    <h2 id="listingTitle" class="text-2xl font-bold text-gray-900 mb-2">T√≠tulo del Listing</h2>
                    <p id="listingProductName" class="text-lg text-gray-600 mb-4">Nombre del Producto</p>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <i class="fas fa-tag text-gray-400 mr-2"></i>
                            <span id="listingCategory" class="text-gray-700">Categor√≠a</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-dollar-sign text-gray-400 mr-2"></i>
                            <span id="listingPrice" class="text-gray-700">$0.00</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-calendar text-gray-400 mr-2"></i>
                            <span id="listingDate" class="text-gray-700">Fecha</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="showTab('overview')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300 active">
                        <i class="fas fa-eye mr-2"></i>Vista General
                    </button>
                    <button onclick="showTab('content')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-file-text mr-2"></i>Contenido
                    </button>
                    <button onclick="showTab('seo')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-search mr-2"></i>SEO & Keywords
                    </button>
                    <button onclick="showTab('images')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-images mr-2"></i>Im√°genes
                    </button>
                    <button onclick="showTab('agents')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-robot mr-2"></i>Agentes IA
                    </button>
                    <button onclick="showTab('raw')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-code mr-2"></i>Datos Raw
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Bullet Points -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-list mr-2 text-blue-600"></i>Puntos Clave
                            </h3>
                            <ul id="bulletPoints" class="space-y-2">
                                <!-- Bullet points will be populated here -->
                            </ul>
                        </div>

                        <!-- Recommendations -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>Recomendaciones
                            </h3>
                            <ul id="recommendations" class="space-y-2">
                                <!-- Recommendations will be populated here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mt-6 bg-white border rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-align-left mr-2 text-green-600"></i>Descripci√≥n del Producto
                        </h3>
                        <div id="productDescription" class="prose max-w-none text-gray-700 whitespace-pre-wrap">
                            <!-- Description will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Content Tab -->
                <div id="content" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Data -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-upload mr-2 text-blue-600"></i>Datos de Entrada
                            </h3>
                            <div id="inputData" class="space-y-4">
                                <!-- Input data will be populated here -->
                            </div>
                        </div>

                        <!-- Processing Notes -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>Notas de Procesamiento
                            </h3>
                            <ul id="processingNotes" class="space-y-2">
                                <!-- Processing notes will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- SEO Tab -->
                <div id="seo" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Search Terms -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-search mr-2 text-blue-600"></i>T√©rminos de B√∫squeda
                            </h3>
                            <div id="searchTerms" class="space-y-4">
                                <!-- Search terms will be populated here -->
                            </div>
                        </div>

                        <!-- Backend Keywords -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-tags mr-2 text-green-600"></i>Keywords Backend
                            </h3>
                            <div id="backendKeywords" class="space-y-2">
                                <!-- Backend keywords will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images Tab -->
                <div id="images" class="tab-content">
                    <div class="space-y-6">
                        <!-- Image Search Controls -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-900 mb-2">
                                        <i class="fas fa-images mr-2"></i>Im√°genes del Producto
                                    </h3>
                                    <p class="text-blue-800 text-sm">
                                        Busca y gestiona las im√°genes para tu listing de Amazon
                                    </p>
                                </div>
                                <div class="flex space-x-3">
                                    <button id="searchImagesBtn" onclick="searchImages()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-search mr-2"></i>Buscar Im√°genes
                                    </button>
                                    <button id="regenerateImagesBtn" onclick="regenerateImages()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-sync mr-2"></i>Regenerar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Image Results -->
                        <div id="imageResults" class="hidden">
                            <!-- Image Statistics -->
                            <div class="bg-white rounded-lg border p-4 mb-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-md font-semibold text-gray-900">
                                        <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Estad√≠sticas de Im√°genes
                                    </h4>
                                    <span id="imageCount" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                                        0 im√°genes encontradas
                                    </span>
                                </div>
                                <div id="imageCategories" class="mt-3 flex flex-wrap gap-2">
                                    <!-- Image categories will be populated here -->
                                </div>
                            </div>

                            <!-- Image Gallery -->
                            <div class="bg-white rounded-lg border p-4">
                                <h4 class="text-md font-semibold text-gray-900 mb-4">
                                    <i class="fas fa-images mr-2 text-green-600"></i>Galer√≠a de Im√°genes
                                </h4>
                                <div id="imageGallery" class="grid grid-responsive gap-4">
                                    <!-- Images will be populated here -->
                                </div>
                            </div>

                            <!-- Image Recommendations -->
                            <div id="imageRecommendations" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="text-md font-semibold text-yellow-900 mb-2">
                                    <i class="fas fa-lightbulb mr-2"></i>Recomendaciones de Im√°genes
                                </h4>
                                <ul id="imageRecommendationsList" class="space-y-1 text-sm text-yellow-800">
                                    <!-- Recommendations will be populated here -->
                                </ul>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="imageLoading" class="hidden">
                            <div class="bg-white rounded-lg border p-8 text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p class="text-gray-600">Buscando im√°genes para tu producto...</p>
                                <p class="text-sm text-gray-500 mt-2">Este proceso puede tardar unos segundos</p>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="imageEmpty" class="bg-white rounded-lg border p-8 text-center">
                            <div class="text-gray-400 mb-4">
                                <i class="fas fa-images text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay im√°genes disponibles</h3>
                            <p class="text-gray-600 mb-4">
                                Haz clic en "Buscar Im√°genes" para obtener im√°genes autom√°ticamente para tu producto
                            </p>
                            <button onclick="searchImages()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-search mr-2"></i>Buscar Im√°genes Ahora
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Agents Tab -->
                <div id="agents" class="tab-content">
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-blue-900 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Resultados de Agentes IA
                            </h3>
                            <p class="text-blue-800 text-sm">
                                Aqu√≠ puedes ver los resultados detallados de cada agente de IA que proces√≥ este listing.
                            </p>
                        </div>
                        <div id="agentResults" class="space-y-4">
                            <!-- Agent results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Raw Data Tab -->
                <div id="raw" class="tab-content">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-database mr-2 text-purple-600"></i>Datos Raw JSON
                        </h3>
                        <div class="bg-black rounded-lg p-4 overflow-x-auto">
                            <pre id="rawData" class="text-green-400 text-sm whitespace-pre-wrap">
                                <!-- Raw data will be populated here -->
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-full hidden">
        <span id="toastMessage"></span>
    </div>

    <script src="/static/config.js"></script>
    <script>
        // Global variables
        let currentListing = null;
        // Usar configuraci√≥n din√°mica de API base URL
        const API_BASE_URL = window.Config ? window.Config.getApiBaseUrl() : 
            `${window.location.protocol}//${window.location.hostname}:${window.location.port || '8000'}`;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const listingId = urlParams.get('id');
            
            if (listingId) {
                loadListingDetails(listingId);
            } else {
                showToast('No se especific√≥ ID de listing', 'error');
            }
        });

        // Load listing details
        async function loadListingDetails(listingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/listings/${listingId}`);
                if (!response.ok) throw new Error('Error al cargar listing');
                
                const data = await response.json();
                currentListing = data.listing;
                
                populateListingDetails(data.listing);
                populateAgentResults(data.agent_results || []);
                
                // Load existing images
                await loadExistingImages();
                
                showToast('Listing cargado exitosamente', 'success');
            } catch (error) {
                console.error('Error loading listing:', error);
                showToast('Error al cargar el listing', 'error');
            }
        }

        // Populate listing details
        function populateListingDetails(listing) {
            // Header information
            document.getElementById('listingId').textContent = `ID: #${listing.id}`;
            document.getElementById('listingTitle').textContent = listing.title || 'Sin t√≠tulo';
            document.getElementById('listingProductName').textContent = listing.product_name || 'Sin nombre';
            document.getElementById('listingCategory').textContent = (listing.category || '').replace('ProductCategory.', '');
            document.getElementById('listingPrice').textContent = `$${listing.target_price || 0}`;
            document.getElementById('listingDate').textContent = new Date(listing.created_at).toLocaleDateString('es-ES');
            
            // Status and confidence
            const statusEl = document.getElementById('listingStatus');
            const status = listing.status || 'unknown';
            statusEl.className = `px-3 py-1 rounded-full text-sm font-medium ${getStatusClass(status)}`;
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            const confidenceEl = document.getElementById('listingConfidence');
            const confidence = Math.round((listing.confidence_score || 0) * 100);
            confidenceEl.textContent = `Confianza: ${confidence}%`;
            confidenceEl.className = `px-3 py-1 rounded-full text-sm font-medium ${getConfidenceClass(confidence)}`;

            // Bullet points
            const bulletPointsEl = document.getElementById('bulletPoints');
            if (listing.bullet_points && listing.bullet_points.length > 0) {
                bulletPointsEl.innerHTML = listing.bullet_points.map(point => 
                    `<li class="flex items-start"><i class="fas fa-check text-green-500 mr-2 mt-1"></i><span class="text-sm text-gray-700">${point}</span></li>`
                ).join('');
            } else {
                bulletPointsEl.innerHTML = '<li class="text-gray-500 text-sm">No hay puntos clave disponibles</li>';
            }

            // Recommendations
            const recommendationsEl = document.getElementById('recommendations');
            if (listing.recommendations && listing.recommendations.length > 0) {
                recommendationsEl.innerHTML = listing.recommendations.map((rec, index) => 
                    `<li class="flex items-start justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200 mb-2" data-recommendation-id="general-${index}">
                        <div class="flex items-start flex-1">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2 mt-1"></i>
                            <span class="text-sm text-gray-700">${rec}</span>
                        </div>
                        <div class="flex items-center ml-3">
                            <span class="applied-badge hidden text-green-600 text-xs font-medium mr-2">
                                <i class="fas fa-check-circle mr-1"></i>
                                Aplicado
                            </span>
                            <button onclick="applyRecommendation('general', ${index}, '${rec.replace(/'/g, "\\'")}', '${getCurrentListingId()}')" 
                                    class="apply-btn px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-colors flex items-center"
                                    title="Aplicar esta recomendaci√≥n">
                                <i class="fas fa-magic-wand-sparkles mr-1"></i>
                                Aplicar
                            </button>
                        </div>
                    </li>`
                ).join('');
            } else {
                recommendationsEl.innerHTML = '<li class="text-gray-500 text-sm">No hay recomendaciones disponibles</li>';
            }

            // Description
            const descriptionEl = document.getElementById('productDescription');
            descriptionEl.textContent = listing.description || 'No hay descripci√≥n disponible';

            // Input data
            const inputDataEl = document.getElementById('inputData');
            if (listing.input_data) {
                const inputData = listing.input_data;
                inputDataEl.innerHTML = `
                    <div class="space-y-3">
                        <div><strong>Propuesta de Valor:</strong> ${inputData.value_proposition || 'N/A'}</div>
                        <div><strong>Cliente Objetivo:</strong> ${inputData.target_customer_description || 'N/A'}</div>
                        <div><strong>Especificaciones:</strong> ${inputData.raw_specifications || 'N/A'}</div>
                        <div><strong>Contenido de la Caja:</strong> ${inputData.box_content_description || 'N/A'}</div>
                        <div><strong>Garant√≠a:</strong> ${inputData.warranty_info || 'N/A'}</div>
                    </div>
                `;
            } else {
                inputDataEl.innerHTML = '<div class="text-gray-500 text-sm">No hay datos de entrada disponibles</div>';
            }

            // Processing notes
            const processingNotesEl = document.getElementById('processingNotes');
            if (listing.processing_notes && listing.processing_notes.length > 0) {
                processingNotesEl.innerHTML = listing.processing_notes.map(note => 
                    `<li class="flex items-start"><i class="fas fa-info-circle text-blue-500 mr-2 mt-1"></i><span class="text-sm text-gray-700">${note}</span></li>`
                ).join('');
            } else {
                processingNotesEl.innerHTML = '<li class="text-gray-500 text-sm">No hay notas de procesamiento</li>';
            }

            // Search terms
            const searchTermsEl = document.getElementById('searchTerms');
            if (listing.search_terms && listing.search_terms.length > 0) {
                searchTermsEl.innerHTML = `
                    <div class="flex flex-wrap gap-2">
                        ${listing.search_terms.map(term => 
                            `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${term}</span>`
                        ).join('')}
                    </div>
                `;
            } else {
                searchTermsEl.innerHTML = '<div class="text-gray-500 text-sm">No hay t√©rminos de b√∫squeda</div>';
            }

            // Backend keywords
            const backendKeywordsEl = document.getElementById('backendKeywords');
            if (listing.backend_keywords && listing.backend_keywords.length > 0) {
                backendKeywordsEl.innerHTML = `
                    <div class="flex flex-wrap gap-2">
                        ${listing.backend_keywords.map(keyword => 
                            `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${keyword}</span>`
                        ).join('')}
                    </div>
                `;
            } else {
                backendKeywordsEl.innerHTML = '<div class="text-gray-500 text-sm">No hay keywords backend</div>';
            }

            // Raw data
            const rawDataEl = document.getElementById('rawData');
            rawDataEl.textContent = JSON.stringify(listing, null, 2);
            
            // Load applied recommendations state
            setTimeout(() => {
                loadAppliedRecommendations(listing.id);
            }, 100);
        }

        // Populate agent results
        function populateAgentResults(agentResults) {
            const agentResultsEl = document.getElementById('agentResults');
            
            if (agentResults.length === 0) {
                agentResultsEl.innerHTML = '<div class="text-gray-500 text-sm">No hay resultados de agentes disponibles</div>';
                return;
            }

            agentResultsEl.innerHTML = agentResults.map(agent => {
                const statusClass = agent.status === 'success' ? 'success' : 
                                   agent.status === 'partial' ? 'partial' : 'error';
                const statusIcon = agent.status === 'success' ? 'check-circle' : 
                                  agent.status === 'partial' ? 'exclamation-triangle' : 'times-circle';
                
                return `
                    <div class="agent-result ${statusClass} bg-white rounded-lg p-4 pl-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-${statusIcon} mr-2 ${statusClass === 'success' ? 'text-green-600' : statusClass === 'partial' ? 'text-yellow-600' : 'text-red-600'}"></i>
                                <h4 class="font-semibold text-gray-900">${agent.agent_name}</h4>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-500">Confianza: ${Math.round((agent.confidence || 0) * 100)}%</span>
                                <span class="text-sm text-gray-500">Tiempo: ${agent.processing_time?.toFixed(2) || 0}s</span>
                            </div>
                        </div>
                        ${agent.recommendations && agent.recommendations.length > 0 ? `
                            <div class="mb-3">
                                <h5 class="font-medium text-gray-700 mb-2">Recomendaciones:</h5>
                                <div class="space-y-2">
                                    ${agent.recommendations.map((rec, index) => `
                                        <div class="flex items-start justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                            <div class="flex items-start flex-1">
                                                <i class="fas fa-lightbulb text-yellow-500 mr-2 mt-1"></i>
                                                <span class="text-sm text-gray-700">${rec}</span>
                                            </div>
                                            <button onclick="applyRecommendation('${agent.agent_name}', ${index}, '${rec.replace(/'/g, "\\'")}', '${getCurrentListingId()}')" 
                                                    class="ml-3 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-colors flex items-center"
                                                    title="Aplicar esta recomendaci√≥n">
                                                <i class="fas fa-magic-wand-sparkles mr-1"></i>
                                                Aplicar
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${agent.notes && agent.notes.length > 0 ? `
                            <div>
                                <h5 class="font-medium text-gray-700 mb-2">Notas:</h5>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    ${agent.notes.map(note => `<li>‚Ä¢ ${note}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Utility functions
        function getStatusClass(status) {
            switch (status) {
                case 'published': return 'bg-green-100 text-green-800';
                case 'draft': return 'bg-yellow-100 text-yellow-800';
                case 'archived': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 80) return 'bg-green-100 text-green-800';
            if (confidence >= 60) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function exportListing() {
            if (!currentListing) {
                showToast('No hay listing para exportar', 'error');
                return;
            }

            const dataStr = JSON.stringify(currentListing, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `listing_${currentListing.id}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Listing exportado exitosamente', 'success');
        }

        function editListing() {
            if (!currentListing) {
                showToast('No hay listing para editar', 'error');
                return;
            }
            
            // Redirect to edit page (to be implemented)
            showToast('Funci√≥n de edici√≥n en desarrollo', 'info');
        }

        // Function to get current listing ID
        function getCurrentListingId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Function to apply a recommendation
        async function applyRecommendation(agentName, recommendationIndex, recommendationText, listingId) {
            console.log('ü™Ñ Aplicando recomendaci√≥n:', {
                agentName,
                recommendationIndex,
                recommendationText,
                listingId
            });

            // Determine recommendation ID based on agent name
            const recommendationId = `${agentName.toLowerCase()}-${recommendationIndex}`;
            const element = document.querySelector(`[data-recommendation-id="${recommendationId}"]`);
            
            if (!element) {
                console.error('No se encontr√≥ el elemento de recomendaci√≥n');
                return;
            }
            
            const appliedBadge = element.querySelector('.applied-badge');
            const applyBtn = element.querySelector('.apply-btn');
            
            // Check if already applied
            if (applyBtn.classList.contains('hidden')) {
                showToast('Esta recomendaci√≥n ya fue aplicada', 'info');
                return;
            }

            // Show loading state
            const originalContent = applyBtn.innerHTML;
            applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Aplicando...';
            applyBtn.disabled = true;

            try {
                // Call API to apply recommendation
                const response = await fetch(`${API_BASE_URL}/api/listings/${listingId}/apply-recommendation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agent_name: agentName,
                        recommendation_index: recommendationIndex,
                        recommendation_text: recommendationText
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show success message
                showToast('‚úÖ Recomendaci√≥n aplicada exitosamente', 'success');
                
                // Update visual state
                appliedBadge.classList.remove('hidden');
                applyBtn.classList.add('hidden');
                
                // Change background to indicate applied
                element.classList.remove('bg-yellow-50', 'border-yellow-200');
                element.classList.add('bg-green-50', 'border-green-200');
                
                // Store in localStorage for persistence
                storeAppliedRecommendation(listingId, recommendationId, recommendationText);
                
                console.log('‚úÖ Recomendaci√≥n aplicada:', recommendationText);

            } catch (error) {
                console.error('Error aplicando recomendaci√≥n:', error);
                showToast(`Error: ${error.message}`, 'error');
                
                // Restore button state
                applyBtn.innerHTML = originalContent;
                applyBtn.disabled = false;
            }
        }

        // Function to show toast notifications
        function showToast(message, type = 'info') {
            // Create toast if it doesn't exist
            let toast = document.getElementById('recommendationToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'recommendationToast';
                toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-full z-50';
                document.body.appendChild(toast);
            }

            // Set message and style
            toast.textContent = message;
            
            let bgColor;
            switch(type) {
                case 'success': bgColor = 'bg-green-500 text-white'; break;
                case 'error': bgColor = 'bg-red-500 text-white'; break;
                case 'warning': bgColor = 'bg-yellow-500 text-white'; break;
                default: bgColor = 'bg-blue-500 text-white'; break;
            }
            
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${bgColor}`;
            
            // Show toast
            toast.classList.remove('translate-y-full');
            
            // Hide after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-y-full');
            }, 4000);
        }

        // Image search functions
        async function searchImages() {
            if (!currentListing) {
                showToast('No hay listing cargado', 'error');
                return;
            }

            const button = document.getElementById('searchImagesBtn');
            const originalContent = button.innerHTML;
            
            try {
                // Show loading state
                showImageLoading();
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';
                button.disabled = true;

                // Prepare search data
                const searchData = {
                    product_name: currentListing.product_name,
                    description: currentListing.description || '',
                    category: currentListing.category || 'Other',
                    features: currentListing.bullet_points || [],
                    target_audience: 'General',
                    price_range: `$${currentListing.target_price || 0}`
                };

                // Make API call
                const response = await fetch(`${API_BASE_URL}/api/listings/search-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    displayImages(data);
                    showToast('Im√°genes encontradas exitosamente', 'success');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }

            } catch (error) {
                console.error('Error searching images:', error);
                showToast(`Error al buscar im√°genes: ${error.message}`, 'error');
                showImageEmpty();
            } finally {
                // Restore button
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        async function regenerateImages() {
            if (!currentListing) {
                showToast('No hay listing cargado', 'error');
                return;
            }

            const button = document.getElementById('regenerateImagesBtn');
            const originalContent = button.innerHTML;
            
            try {
                // Show loading state
                showImageLoading();
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerando...';
                button.disabled = true;

                // Make API call
                const response = await fetch(`${API_BASE_URL}/api/listings/${currentListing.id}/regenerate-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    displayImages(data);
                    showToast('Im√°genes regeneradas exitosamente', 'success');
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }

            } catch (error) {
                console.error('Error regenerating images:', error);
                showToast(`Error al regenerar im√°genes: ${error.message}`, 'error');
                showImageEmpty();
            } finally {
                // Restore button
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        function displayImages(data) {
            const imageResults = document.getElementById('imageResults');
            const imageEmpty = document.getElementById('imageEmpty');
            const imageLoading = document.getElementById('imageLoading');
            const imageCount = document.getElementById('imageCount');
            const imageGallery = document.getElementById('imageGallery');
            const imageCategories = document.getElementById('imageCategories');
            const imageRecommendationsList = document.getElementById('imageRecommendationsList');

            // Hide loading and empty states
            imageLoading.classList.add('hidden');
            imageEmpty.classList.add('hidden');
            
            // Show results
            imageResults.classList.remove('hidden');

            // Update count with additional info
            const totalImages = data.total_images || data.images?.length || 0;
            const confidence = data.confidence ? `(${(data.confidence * 100).toFixed(0)}% confianza)` : '';
            const productType = data.product_type ? `Tipo: ${data.product_type}` : '';
            
            let countText = `<span class="total-images-count">${totalImages}</span> im√°genes encontradas`;
            if (productType) {
                countText += ` ‚Ä¢ ${productType}`;
            }
            if (confidence) {
                countText += ` ‚Ä¢ ${confidence}`;
            }
            
            imageCount.innerHTML = countText;

            // Clear and populate gallery
            imageGallery.innerHTML = '';
            
            if (data.images && data.images.length > 0) {
                data.images.forEach((imageData, index) => {
                    // Handle both string paths and object format
                    let imagePath, filename, title, searchTerm, relevanceScore;
                    
                    if (typeof imageData === 'string') {
                        // Old format: simple string path
                        imagePath = imageData;
                        filename = imageData.split('/').pop();
                        title = `Imagen ${index + 1}`;
                        searchTerm = '';
                        relevanceScore = 0;
                    } else {
                        // New format: object with properties
                        imagePath = imageData.original_url || imageData.local_path || imageData.url;
                        filename = imageData.filename || (imagePath ? imagePath.split('/').pop() : `imagen_${index + 1}`);
                        title = imageData.title || `Imagen ${index + 1}`;
                        searchTerm = imageData.search_term || '';
                        relevanceScore = imageData.relevance_score || 0;
                    }
                    
                    const imageCard = document.createElement('div');
                    imageCard.className = 'bg-white border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow image-card';
                    
                    // Add relevance score indicator
                    const relevanceClass = relevanceScore > 0.8 ? 'bg-green-600' : 
                                         relevanceScore > 0.6 ? 'bg-yellow-600' : 'bg-gray-600';
                    
                    imageCard.innerHTML = `
                        <div class="aspect-square relative">
                            <!-- Loading placeholder -->
                            <div class="loading-placeholder absolute inset-0 flex items-center justify-center bg-gray-100">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            </div>
                            
                            <img src="${imagePath}" alt="${title}" 
                                 class="w-full h-full object-cover"
                                 onerror="hideImageCard(this)"
                                 onload="showImageCard(this)">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs image-overlay opacity-80">
                                ${index + 1}
                            </div>
                            ${relevanceScore > 0 ? `
                                <div class="absolute top-2 left-2 ${relevanceClass} text-white px-2 py-1 rounded text-xs">
                                    ${(relevanceScore * 100).toFixed(0)}%
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-3">
                            <p class="text-sm font-medium text-gray-800 truncate" title="${title}">${title}</p>
                            ${searchTerm ? `<p class="text-xs text-gray-500 mt-1">T√©rmino: ${searchTerm}</p>` : ''}
                            <div class="mt-2 flex space-x-2">
                                <button onclick="downloadImage('${imagePath}')" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded text-sm transition-colors">
                                    <i class="fas fa-download mr-1"></i>Descargar
                                </button>
                                <button onclick="viewImageFullscreen('${imagePath}')" 
                                        class="bg-gray-600 hover:bg-gray-700 text-white py-1 px-2 rounded text-sm transition-colors">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Initially hide the card until image loads
                    imageCard.style.display = 'none';
                    imageGallery.appendChild(imageCard);
                });
            } else {
                imageGallery.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No se encontraron im√°genes</div>';
            }

            // Update categories - support both old and new format
            imageCategories.innerHTML = '';
            const categoriesData = data.image_categories || data.organized_images || {};
            
            if (Object.keys(categoriesData).length > 0) {
                Object.entries(categoriesData).forEach(([category, images]) => {
                    const categoryBadge = document.createElement('span');
                    categoryBadge.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm';
                    
                    // Format category name
                    const formattedCategory = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const imageCount = Array.isArray(images) ? images.length : 0;
                    
                    categoryBadge.textContent = `${formattedCategory}: ${imageCount}`;
                    imageCategories.appendChild(categoryBadge);
                });
            }

            // Update recommendations
            imageRecommendationsList.innerHTML = '';
            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach((recommendation, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start justify-between';
                    li.setAttribute('data-recommendation-id', `image-${index}`);
                    li.innerHTML = `
                        <div class="flex items-start flex-1">
                            <i class="fas fa-lightbulb text-yellow-600 mr-2 mt-0.5"></i>
                            <span>${recommendation}</span>
                        </div>
                        <div class="flex items-center ml-3">
                            <span class="applied-badge hidden text-green-600 text-xs font-medium mr-2">
                                <i class="fas fa-check-circle mr-1"></i>
                                Aplicado
                            </span>
                            <button onclick="applyRecommendation('image', ${index}, '${recommendation.replace(/'/g, "\\'")}', '${getCurrentListingId()}')" 
                                    class="apply-btn px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors flex items-center"
                                    title="Aplicar esta recomendaci√≥n">
                                <i class="fas fa-check mr-1"></i>
                                Aplicar
                            </button>
                        </div>
                    `;
                    imageRecommendationsList.appendChild(li);
                });
            } else {
                imageRecommendationsList.innerHTML = '<li class="text-gray-500">No hay recomendaciones disponibles</li>';
            }
            
            // Load applied recommendations state for image recommendations
            setTimeout(() => {
                loadAppliedRecommendations(getCurrentListingId());
            }, 100);
        }

        function showImageLoading() {
            document.getElementById('imageResults').classList.add('hidden');
            document.getElementById('imageEmpty').classList.add('hidden');
            document.getElementById('imageLoading').classList.remove('hidden');
        }

        function showImageEmpty() {
            document.getElementById('imageResults').classList.add('hidden');
            document.getElementById('imageLoading').classList.add('hidden');
            document.getElementById('imageEmpty').classList.remove('hidden');
        }

        function downloadImage(imagePath) {
            // Create a temporary link to download the image
            const link = document.createElement('a');
            link.href = imagePath;
            link.download = imagePath.split('/').pop();
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Descarga iniciada', 'success');
        }

        // Load existing images when listing is loaded
        async function loadExistingImages() {
            if (!currentListing) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/listings/${currentListing.id}/images`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.images && data.images.length > 0) {
                        // Transform data to match search-images format
                        const transformedData = {
                            success: true,
                            images: data.images,
                            organized_images: data.organized_images || {},
                            total_images: data.total_images || data.images.length,
                            recommendations: data.recommendations || []
                        };
                        displayImages(transformedData);
                    }
                }
            } catch (error) {
                console.error('Error loading existing images:', error);
                // Don't show error toast for this, just show empty state
            }
        }

        function viewImageFullscreen(imagePath) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.onclick = () => document.body.removeChild(modal);
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'max-w-4xl max-h-4xl p-4';
            modalContent.onclick = (e) => e.stopPropagation();
            
            modalContent.innerHTML = `
                <div class="relative">
                    <img src="${imagePath}" alt="Imagen en pantalla completa" 
                         class="max-w-full max-h-full object-contain">
                    <button onclick="document.body.removeChild(this.closest('.fixed'))" 
                            class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-3 py-1 rounded">
                        ${imagePath.split('/').pop()}
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // Functions to handle image loading and errors
        function showImageCard(imgElement) {
            // Show the image card when image loads successfully
            const imageCard = imgElement.closest('.image-card');
            if (imageCard) {
                // Hide loading placeholder
                const loadingPlaceholder = imageCard.querySelector('.loading-placeholder');
                if (loadingPlaceholder) {
                    loadingPlaceholder.style.display = 'none';
                }
                
                // Show the image card
                imageCard.style.display = 'block';
                imageCard.style.opacity = '0';
                imageCard.style.transition = 'opacity 0.3s ease-in-out';
                
                // Fade in effect
                setTimeout(() => {
                    imageCard.style.opacity = '1';
                }, 50);
                
                // Update counter
                updateImageCounter();
            }
        }

        function hideImageCard(imgElement) {
            // Hide the image card when image fails to load
            const imageCard = imgElement.closest('.image-card');
            if (imageCard) {
                imageCard.style.display = 'none';
                // Update the counter
                updateImageCounter();
            }
        }

        function updateImageCounter() {
            // Update the displayed image count
            const allCards = document.querySelectorAll('.image-card');
            let visibleCount = 0;
            
            allCards.forEach(card => {
                const computedStyle = window.getComputedStyle(card);
                if (computedStyle.display !== 'none') {
                    visibleCount++;
                }
            });
            
            const totalImagesSpan = document.querySelector('.total-images-count');
            if (totalImagesSpan) {
                totalImagesSpan.textContent = visibleCount;
            }
        }

        // Function to store applied recommendations
        function storeAppliedRecommendation(listingId, recommendationId, recommendation) {
            const key = `applied_recommendations_${listingId}`;
            let applied = JSON.parse(localStorage.getItem(key) || '{}');
            
            applied[recommendationId] = {
                recommendation: recommendation,
                appliedAt: new Date().toISOString()
            };
            
            localStorage.setItem(key, JSON.stringify(applied));
        }

        // Function to load applied recommendations
        function loadAppliedRecommendations(listingId) {
            const key = `applied_recommendations_${listingId}`;
            const applied = JSON.parse(localStorage.getItem(key) || '{}');
            
            // Apply the stored states
            Object.keys(applied).forEach(recommendationId => {
                const element = document.querySelector(`[data-recommendation-id="${recommendationId}"]`);
                if (element) {
                    const appliedBadge = element.querySelector('.applied-badge');
                    const applyBtn = element.querySelector('.apply-btn');
                    
                    if (appliedBadge && applyBtn) {
                        appliedBadge.classList.remove('hidden');
                        applyBtn.classList.add('hidden');
                        element.classList.remove('bg-yellow-50', 'border-yellow-200');
                        element.classList.add('bg-green-50', 'border-green-200');
                    }
                }
            });
        }
    </script>
</body>
</html>
