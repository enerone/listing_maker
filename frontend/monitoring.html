<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Monitoreo - Listings AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-offline { background-color: #ef4444; }
        
        .metric-card {
            transition: transform 0.2s ease-in-out;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .refresh-animation {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Sistema de Monitoreo</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-2" id="refreshIcon"></i>
                        Actualizar
                    </button>
                    <a href="/dashboard.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- System Status Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-server text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Estado del Backend</p>
                        <div class="flex items-center mt-1">
                            <span class="status-indicator" id="backendIndicator"></span>
                            <span class="text-lg font-semibold text-gray-900" id="backendStatus">Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-robot text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Agentes IA</p>
                        <div class="flex items-center mt-1">
                            <span class="status-indicator" id="aiIndicator"></span>
                            <span class="text-lg font-semibold text-gray-900" id="aiStatus">Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-database text-purple-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Base de Datos</p>
                        <div class="flex items-center mt-1">
                            <span class="status-indicator" id="dbIndicator"></span>
                            <span class="text-lg font-semibold text-gray-900" id="dbStatus">Verificando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-list text-indigo-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Listings</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalListings">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-percentage text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Tasa de Éxito</p>
                        <p class="text-2xl font-semibold text-gray-900" id="successRate">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-star text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Confidence Promedio</p>
                        <p class="text-2xl font-semibold text-gray-900" id="avgConfidence">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-cogs text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Procesos Agentes</p>
                        <p class="text-2xl font-semibold text-gray-900" id="agentProcesses">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Información del Sistema</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-4">Configuración</h4>
                        <dl class="space-y-3">
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-600">Versión del Sistema:</dt>
                                <dd class="text-sm font-medium text-gray-900">v1.0.0</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-600">Tiempo de Actividad:</dt>
                                <dd class="text-sm font-medium text-gray-900" id="uptime">-</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm text-gray-600">Última Actualización:</dt>
                                <dd class="text-sm font-medium text-gray-900" id="lastUpdate">-</dd>
                            </div>
                        </dl>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-4">Endpoints Activos</h4>
                        <div class="space-y-2" id="endpointsList">
                            <div class="flex items-center">
                                <span class="status-indicator status-online"></span>
                                <span class="text-sm text-gray-700">/listings/</span>
                            </div>
                            <div class="flex items-center">
                                <span class="status-indicator status-online"></span>
                                <span class="text-sm text-gray-700">/listings/create-simple</span>
                            </div>
                            <div class="flex items-center">
                                <span class="status-indicator status-online"></span>
                                <span class="text-sm text-gray-700">/listings/metrics</span>
                            </div>
                            <div class="flex items-center">
                                <span class="status-indicator status-online"></span>
                                <span class="text-sm text-gray-700">/status</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Actividad Reciente del Sistema</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="recentActivity">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-900">Sistema iniciado correctamente</p>
                            <p class="text-xs text-gray-500">Hace 2 horas</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-900">Tests de integración ejecutados exitosamente</p>
                            <p class="text-xs text-gray-500">Hace 5 minutos</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-plus-circle text-green-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-900">Nuevo listing creado automáticamente</p>
                            <p class="text-xs text-gray-500">Hace 3 minutos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Usar configuración dinámica de API base URL
        const API_BASE_URL = window.Config ? window.Config.getApiBaseUrl() : 
            `${window.location.protocol}//${window.location.hostname}:${window.location.port || '8000'}`;

        // Initialize monitoring
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema de monitoreo inicializado');
            loadSystemData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadSystemData, 30000);
        });

        async function loadSystemData() {
            try {
                // Load system status and metrics
                const [statusResponse, metricsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/status`),
                    fetch(`${API_BASE_URL}/api/listings/metrics`)
                ]);

                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    updateSystemStatus(statusData);
                }

                if (metricsResponse.ok) {
                    const metricsData = await metricsResponse.json();
                    updateMetrics(metricsData);
                }

            } catch (error) {
                console.error('Error loading system data:', error);
                showError();
            }
        }

        function updateSystemStatus(status) {
            // Backend status
            const backendIndicator = document.getElementById('backendIndicator');
            const backendStatus = document.getElementById('backendStatus');
            
            if (status.system === 'online') {
                backendIndicator.className = 'status-indicator status-online';
                backendStatus.textContent = 'Operativo';
            } else {
                backendIndicator.className = 'status-indicator status-offline';
                backendStatus.textContent = 'Desconectado';
            }

            // AI status
            const aiIndicator = document.getElementById('aiIndicator');
            const aiStatus = document.getElementById('aiStatus');
            
            if (status.ollama_connected) {
                aiIndicator.className = 'status-indicator status-online';
                aiStatus.textContent = `Activo (${status.agents_ready}/${status.agents_total})`;
            } else {
                aiIndicator.className = 'status-indicator status-warning';
                aiStatus.textContent = 'Limitado';
            }

            // DB status (assume working if backend is online)
            const dbIndicator = document.getElementById('dbIndicator');
            const dbStatus = document.getElementById('dbStatus');
            
            if (status.system === 'online') {
                dbIndicator.className = 'status-indicator status-online';
                dbStatus.textContent = 'Conectada';
            } else {
                dbIndicator.className = 'status-indicator status-offline';
                dbStatus.textContent = 'Error';
            }
        }

        function updateMetrics(metrics) {
            document.getElementById('totalListings').textContent = metrics.total_listings;
            document.getElementById('successRate').textContent = `${Math.round(metrics.success_rate * 100)}%`;
            document.getElementById('avgConfidence').textContent = `${Math.round(metrics.average_confidence * 100)}%`;
            document.getElementById('agentProcesses').textContent = metrics.total_agent_results;

            // Update system info
            document.getElementById('uptime').textContent = `${metrics.uptime_hours} horas`;
            document.getElementById('lastUpdate').textContent = new Date(metrics.generated_at).toLocaleString('es-ES');
        }

        function showError() {
            // Update indicators to show error state
            ['backendIndicator', 'aiIndicator', 'dbIndicator'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.className = 'status-indicator status-offline';
                }
            });

            ['backendStatus', 'aiStatus', 'dbStatus'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'Error';
                }
            });
        }

        function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            
            refreshBtn.disabled = true;
            refreshIcon.classList.add('refresh-animation');
            
            loadSystemData().finally(() => {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshIcon.classList.remove('refresh-animation');
                }, 1000);
            });
        }
    </script>
</body>
</html>
